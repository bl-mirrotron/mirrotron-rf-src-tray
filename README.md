# RF Frequency Source
* <a href="https://github.com/bl-mirrotron/mirrotron-rf-src-tray" target="_blank">Source code</a>
* [RF source overview](https://bl-mirrotron.github.io/#rf-source)
* [Control system overview](https://bl-mirrotron.github.io/)

<a href="" target="_blank"></a>

The function of the RF frequency source is to provide pulsed 200 MHz RF with frequency and amplitude control. In addition it provides a local oscillator signal to the Phase Detector module and in return receives a frequency error signal from the Phase detector. The block diagram of the frequency source is shown in Figure 1. The RF signal is generated by a Direct Digital Synthesizer (DDS) implemented by the <a href="https://redpitaya.com/stemlab-125-14/" target="_blank">Red Pitaya Stemlab 125-14</a> FPGA. The FPGA was programmed with the <a href="https://content.redpitaya.com/blog/canvas-a-free-graphical-dsp-design-tool-for-red-pitayas-fpga" target="_blank">CANVAS</a> tool that is a graphical system for implementing digital signal processing functions into the Stemlab 125-14 FPGA. The CANVAS circuit is shown in Figure 2.

The clock of the Stemlab 125-14 is 125MHz so a 200 MHz signal cannot be generated directly. Instead a 12.5 MHz signal is generated by the DDS and then this signal is multiplied up to 100 MHz with 8x phase lock loop withe the <a href="https://bl-mirrotron.github.io/mirrotron-rfq-llrf-timer-cube">RFQ LLRF Timer Cube circuit</a>. The signal is then frequency doubled to 200 MHz. The phase increment on the DDS is set by a 32 bit word so the final frequency resolution is less than 0.5 Hz out of 200MHz.

The tray code uses the Blinky-lite Canvas interface in which all settings are mapped to a GPIO memory address on the Red Pitaya. The tray code is shown in Figure 3.

The RF Frequency source is the main actuator for the [Machine Permit system](https://bl-mirrotron.github.io/#machine-protection-system). When the Machine Permit system detects a fault, the tray code shown in Figure 4 resets the Direct Digtal Synthesizer which disables any RF output from the RF Frequency source.

<p></p><p style="text-align:center;font-size: large;"><span style="font-weight: bold;color: green;">Figure 1. </span> <span style="font-style: italic;">RF Frequency Source Block Diagram</span></p>
<div style="width:100%;text-align:center;"><img width="100%" style="border-style:solid;border-color:#1c6e97;" src="doc/LLRF-Freq-Source.png"/></div><br>

<p></p><p style="text-align:center;font-size: large;"><span style="font-weight: bold;color: green;">Figure 2. </span> <span style="font-style: italic;">RF Frequency Source DSP Code</span></p>
<div style="width:100%;text-align:center;"><img width="100%" style="border-style:solid;border-color:#1c6e97;" src="doc/mirrotron-rf-src.png"/></div><br>

<p></p><p style="text-align:center;font-size: large;"><span style="font-weight: bold;color: green;">Figure 3. </span> <span style="font-style: italic;">RF Frequency Source Tray Code</span></p>
<div style="width:100%;text-align:center;"><img width="100%" style="border-style:solid;border-color:#1c6e97;" src="doc/rf-src-tray.png"/></div><br>

<p></p><p style="text-align:center;font-size: large;"><span style="font-weight: bold;color: green;">Figure 4. </span> <span style="font-style: italic;">RF Frequency Source Machine Protection Code</span></p>
<div style="width:100%;text-align:center;"><img width="100%" style="border-style:solid;border-color:#1c6e97;" src="doc/rf-src-machine-permit.png"/></div><br>

